<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>✈️ Airport Runway Management - Live Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%);
            min-height: 100vh;
            padding: 15px;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.98);
            padding: 25px 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            color: #1e3c72;
            font-size: 2.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.5em;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        /* Connection Status */
        .connection-panel {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 15px;
        }

        .status-indicator {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            animation: pulse 2s infinite;
            position: relative;
        }

        .status-indicator::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            animation: ripple 2s infinite;
        }

        @keyframes ripple {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(2.5); opacity: 0; }
        }

        .status-connected {
            background: #10b981;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }

        .status-connected::after {
            background: #10b981;
        }

        .status-disconnected {
            background: #ef4444;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        .status-disconnected::after {
            background: #ef4444;
        }

        .status-text {
            font-weight: 600;
            font-size: 1.1em;
        }

        .status-details {
            color: #666;
            font-size: 0.9em;
            margin-left: auto;
        }

        /* Control Panel */
        .control-panel {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Time Display */
        .time-display {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px 25px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 1.3em;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }

        .time-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .time-label {
            color: #888;
            font-size: 0.7em;
            margin-bottom: 5px;
        }

        .time-value {
            color: #00ff00;
            font-size: 1.2em;
            font-weight: bold;
        }

        /* Grid Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .panel h3 {
            color: #1e3c72;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel-icon {
            font-size: 1.5em;
        }

        /* Runway Cards */
        .runway-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .runway-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 10px;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .runway-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }

        .runway-name {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .runway-status {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .runway-status.occupied {
            background: rgba(239, 68, 68, 0.3);
            border: 2px solid rgba(239, 68, 68, 0.5);
        }

        .runway-status.available {
            background: rgba(16, 185, 129, 0.3);
            border: 2px solid rgba(16, 185, 129, 0.5);
        }

        /* Statistics Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 10px;
            color: white;
            text-align: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.95;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Queue Container */
        .queue-container {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .queue-container::-webkit-scrollbar {
            width: 8px;
        }

        .queue-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .queue-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        .queue-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Flight Cards */
        .flight-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 12px;
            border-left: 5px solid #667eea;
            transition: all 0.3s;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .flight-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .flight-card.priority-emergency {
            border-left-color: #ef4444;
            background: linear-gradient(to right, #fff5f5, #f8f9fa);
            animation: emergencyPulse 2s infinite;
        }

        @keyframes emergencyPulse {
            0%, 100% { border-left-width: 5px; }
            50% { border-left-width: 8px; }
        }

        .flight-card.priority-vip {
            border-left-color: #f59e0b;
            background: linear-gradient(to right, #fffbeb, #f8f9fa);
        }

        .flight-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .flight-id {
            font-weight: bold;
            color: #1e3c72;
            font-size: 1.2em;
        }

        .flight-airline {
            color: #666;
            font-size: 0.9em;
            margin-top: 3px;
        }

        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-scheduled {
            background: #10b981;
            color: white;
        }

        .badge-vip {
            background: #f59e0b;
            color: white;
        }

        .badge-emergency {
            background: #ef4444;
            color: white;
            animation: badgePulse 1.5s infinite;
        }

        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .flight-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e5e7eb;
            font-size: 0.9em;
            color: #666;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-icon {
            font-size: 4em;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .empty-text {
            font-size: 1.1em;
        }

        /* System Log */
        .log-container {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
            font-size: 0.9em;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-left: 3px solid transparent;
            padding-left: 10px;
        }

        .log-entry.log-success {
            border-left-color: #10b981;
            color: #10b981;
        }

        .log-entry.log-error {
            border-left-color: #ef4444;
            color: #ef4444;
        }

        .log-entry.log-warning {
            border-left-color: #f59e0b;
            color: #f59e0b;
        }

        .log-entry.log-info {
            border-left-color: #3b82f6;
            color: #3b82f6;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5em;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .time-display {
                font-size: 0.9em;
            }
            
            .control-panel {
                justify-content: center;
            }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .toast-success {
            border-left: 4px solid #10b981;
        }

        .toast-error {
            border-left: 4px solid #ef4444;
        }

        .toast-warning {
            border-left: 4px solid #f59e0b;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-top">
                <h1>
                    ✈️ Airport Runway Management System
                    <span class="header-badge">LIVE</span>
                </h1>
            </div>
            <div class="connection-panel">
                <span class="status-indicator" id="statusIndicator"></span>
                <span class="status-text" id="connectionStatus">Initializing...</span>
                <span class="status-details" id="statusDetails"></span>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <button class="btn btn-primary" onclick="refreshData()">
                🔄 Refresh Now
            </button>
            <button class="btn btn-success" id="autoRefreshBtn" onclick="toggleAutoRefresh()">
                ▶️ Start Auto-Refresh
            </button>
            <button class="btn btn-warning" onclick="clearLogs()">
                🗑️ Clear Logs
            </button>
            <button class="btn btn-primary" onclick="window.location.reload()">
                🔃 Reset Dashboard
            </button>
            <div style="margin-left: auto; color: white; font-weight: 600;">
                Refresh Rate: <span id="refreshRate">Manual</span>
            </div>
        </div>

        <!-- Operations Panel -->
        <div class="panel" style="margin-bottom:20px;">
            <div class="panel-header">
                <h3><span class="panel-icon">🎛️</span> Operations Control</h3>
            </div>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:16px;">
                <!-- Init Backend -->
                <div style="background:#f8f9ff; padding:16px; border-radius:10px;">
                    <div style="font-weight:700; color:#1e3c72; margin-bottom:8px;">Initialize Backend</div>
                    <label>Algorithm:
                        <select id="initAlgo" style="margin-left:8px; padding:6px; border-radius:6px;">
                            <option value="1">FCFS</option>
                            <option value="2" selected>Priority</option>
                            <option value="3">SJF</option>
                            <option value="4">Round Robin</option>
                        </select>
                    </label>
                    <label style="margin-left:12px;">
                        <input type="checkbox" id="initSamples" checked /> Add sample flights
                    </label>
                    <div style="margin-top:10px;">
                        <button class="btn btn-primary" onclick="apiInit()">🚀 Initialize</button>
                    </div>
                </div>

                <!-- Web Mode -->
                <div style="background:#f8fff9; padding:16px; border-radius:10px;">
                    <div style="font-weight:700; color:#1e3c72; margin-bottom:8px;">Web Dashboard Mode</div>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn btn-primary" onclick="apiWebStart()">🌐 Enter Web Mode</button>
                        <button class="btn btn-success" onclick="apiWebCmd('s')">▶️ Start</button>
                        <button class="btn btn-warning" onclick="apiWebCmd('p')">⏸️ Pause</button>
                        <button class="btn btn-primary" onclick="apiWebCmd('a')">➕ Add Samples</button>
                        <button class="btn btn-danger" onclick="apiWebCmd('q')">🚪 Exit Web Mode</button>
                    </div>
                </div>

                <!-- Simulation -->
                <div style="background:#fffaf5; padding:16px; border-radius:10px;">
                    <div style="font-weight:700; color:#1e3c72; margin-bottom:8px;">Simulation (Main Menu)</div>
                    <div>
                        <label>Duration (minutes):
                            <input id="simMinutes" type="number" value="30" min="1" style="margin-left:8px; padding:6px; width:90px; border-radius:6px;" />
                        </label>
                        <button class="btn btn-primary" style="margin-left:8px;" onclick="apiSimulate()">▶️ Run</button>
                    </div>
                </div>

                <!-- Algorithm Change -->
                <div style="background:#f5fbff; padding:16px; border-radius:10px;">
                    <div style="font-weight:700; color:#1e3c72; margin-bottom:8px;">Change Algorithm (Main Menu)</div>
                    <label>Algorithm:
                        <select id="changeAlgo" style="margin-left:8px; padding:6px; border-radius:6px;">
                            <option value="1">FCFS</option>
                            <option value="2" selected>Priority</option>
                            <option value="3">SJF</option>
                            <option value="4">Round Robin</option>
                        </select>
                    </label>
                    <button class="btn btn-primary" style="margin-left:8px;" onclick="apiChangeAlgo()">🔄 Apply</button>
                </div>
            </div>
        </div>

        <!-- Forms Panel -->
        <div class="panel" style="margin-bottom:20px;">
            <div class="panel-header">
                <h3><span class="panel-icon">🧾</span> Flight Operations</h3>
            </div>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:16px;">
                <!-- Add Flight -->
                <div style="background:#f8f9fa; padding:16px; border-radius:10px;">
                    <div style="font-weight:700; color:#1e3c72; margin-bottom:8px;">Add Flight</div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                        <input id="f_id" placeholder="ID (e.g., AI101)" />
                        <input id="f_airline" placeholder="Airline" />
                        <input id="f_src" placeholder="Source" />
                        <input id="f_dest" placeholder="Destination" />
                        <input id="f_time" type="number" placeholder="Time (min)" />
                        <select id="f_priority">
                            <option value="1">Scheduled</option>
                            <option value="2">VIP</option>
                            <option value="3">Emergency</option>
                        </select>
                        <select id="f_op">
                            <option value="0">Landing</option>
                            <option value="1">Takeoff</option>
                        </select>
                        <input id="f_proc" type="number" placeholder="Process (min)" />
                    </div>
                    <div style="margin-top:10px;">
                        <button class="btn btn-primary" onclick="apiAddFlight()">➕ Add</button>
                    </div>
                </div>

                <!-- Delete Flight -->
                <div style="background:#fff7f7; padding:16px; border-radius:10px;">
                    <div style="font-weight:700; color:#1e3c72; margin-bottom:8px;">Delete Flight</div>
                    <input id="d_id" placeholder="Flight ID" />
                    <div style="margin-top:10px;">
                        <button class="btn btn-danger" onclick="apiDeleteFlight()">🗑️ Delete</button>
                    </div>
                </div>

                <!-- Emergency -->
                <div style="background:#fff5f5; padding:16px; border-radius:10px;">
                    <div style="font-weight:700; color:#1e3c72; margin-bottom:8px;">Add Emergency (Web Mode)</div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                        <select id="e_type">
                            <option value="1">Airport Delay</option>
                            <option value="2">Pilot Unavailability</option>
                            <option value="3">Airplane Defect</option>
                            <option value="4" selected>In-Flight Emergency</option>
                        </select>
                        <input id="e_id" placeholder="Flight ID" />
                        <input id="e_airline" placeholder="Airline" />
                        <input id="e_src" placeholder="Source" />
                        <input id="e_dest" placeholder="Destination" />
                        <input id="e_proc" type="number" placeholder="Process (min)" />
                        <input id="e_details" placeholder="Details" />
                    </div>
                    <div style="margin-top:10px;">
                        <button class="btn btn-danger" onclick="apiEmergency()">🚨 Trigger</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Time Display -->
        <div class="time-display">
            <div class="time-item">
                <div class="time-label">CURRENT TIME</div>
                <div class="time-value" id="currentTime">--:--</div>
            </div>
            <div class="time-item">
                <div class="time-label">ALGORITHM</div>
                <div class="time-value" id="currentAlgo">Loading...</div>
            </div>
            <div class="time-item">
                <div class="time-label">LAST UPDATE</div>
                <div class="time-value" id="lastUpdate">Never</div>
            </div>
            <div class="time-item">
                <div class="time-label">STATUS</div>
                <div class="time-value" id="systemStatus">Idle</div>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Runway Status Panel -->
            <div class="panel">
                <div class="panel-header">
                    <h3><span class="panel-icon">🛫</span> Runway Status</h3>
                </div>
                <div class="runway-grid" id="runwayContainer">
                    <div class="runway-card">
                        <div class="runway-name">Runway A</div>
                        <div class="runway-status available">
                            <div>Initializing...</div>
                        </div>
                    </div>
                    <div class="runway-card">
                        <div class="runway-name">Runway B</div>
                        <div class="runway-status available">
                            <div>Initializing...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics Panel -->
            <div class="panel">
                <div class="panel-header">
                    <h3><span class="panel-icon">📊</span> Live Statistics</h3>
                </div>
                <div class="stats-grid" id="statsContainer">
                    <div class="stat-card">
                        <div class="stat-value">--</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">--</div>
                        <div class="stat-label">Avg Wait</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">--</div>
                        <div class="stat-label">Runway A</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">--</div>
                        <div class="stat-label">Runway B</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Queue Panels -->
        <div class="dashboard-grid">
            <div class="panel">
                <div class="panel-header">
                    <h3><span class="panel-icon">🛬</span> Landing Queue</h3>
                    <span id="landingCount" style="color: #667eea; font-weight: bold;">0</span>
                </div>
                <div class="queue-container" id="landingQueue">
                    <div class="empty-state">
                        <div class="empty-icon">📭</div>
                        <div class="empty-text">Waiting for data...</div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <h3><span class="panel-icon">🛫</span> Takeoff Queue</h3>
                    <span id="takeoffCount" style="color: #667eea; font-weight: bold;">0</span>
                </div>
                <div class="queue-container" id="takeoffQueue">
                    <div class="empty-state">
                        <div class="empty-icon">📭</div>
                        <div class="empty-text">Waiting for data...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Log Panel -->
        <div class="panel">
            <div class="panel-header">
                <h3><span class="panel-icon">📝</span> System Log</h3>
            </div>
            <div class="log-container" id="systemLog">
                <div class="log-entry log-info">[SYSTEM] Dashboard initialized successfully</div>
                <div class="log-entry log-info">[INFO] Waiting for backend connection...</div>
            </div>
        </div>
    </div>

    <script>
        // API helper
        async function postJSON(url, body) {
            const res = await fetch(`/api/${url}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body || {})
            });
            if (!res.ok) throw new Error(`${res.status}`);
            return res.json();
        }

        // Operations API functions
        async function apiInit() {
            try {
                const algo = Number(document.getElementById('initAlgo').value);
                const addSamples = document.getElementById('initSamples').checked;
                await postJSON('init', { algo, addSamples });
                addLog('Backend initialized via API', 'success');
                showToast('Backend initialized!', 'success');
            } catch (e) {
                addLog('Init failed: ' + e.message, 'error');
                showToast('Init failed', 'error');
            }
        }

        async function apiWebStart() {
            try {
                await postJSON('webmode/start', {});
                addLog('Entered Web Dashboard Mode', 'success');
                showToast('Web Mode active', 'success');
            } catch (e) {
                addLog('Web Mode failed: ' + e.message, 'error');
                showToast('Web Mode failed', 'error');
            }
        }

        async function apiWebCmd(cmd) {
            try {
                await postJSON('webmode/cmd', { cmd });
                addLog(`Web cmd '${cmd}' sent`, 'info');
                if (cmd === 'a') showToast('Sample flights added', 'success');
                if (cmd === 'p') showToast('Simulation paused', 'warning');
                if (cmd === 's') showToast('Simulation started', 'success');
                if (cmd === 'q') showToast('Exited Web Mode', 'warning');
            } catch (e) {
                addLog('Web cmd failed: ' + e.message, 'error');
            }
        }

        async function apiSimulate() {
            try {
                const minutes = Number(document.getElementById('simMinutes').value) || 20;
                await postJSON('simulate', { minutes });
                addLog(`Simulation for ${minutes} minutes started`, 'success');
                showToast('Simulation started', 'success');
            } catch (e) {
                addLog('Simulation failed: ' + e.message, 'error');
            }
        }

        async function apiChangeAlgo() {
            try {
                const algo = Number(document.getElementById('changeAlgo').value);
                await postJSON('algorithm', { algo });
                addLog('Algorithm changed', 'success');
                showToast('Algorithm updated', 'success');
            } catch (e) {
                addLog('Change algorithm failed: ' + e.message, 'error');
            }
        }

        async function apiAddFlight() {
            try {
                const body = {
                    id: document.getElementById('f_id').value,
                    airline: document.getElementById('f_airline').value,
                    source: document.getElementById('f_src').value,
                    destination: document.getElementById('f_dest').value,
                    scheduledTime: Number(document.getElementById('f_time').value),
                    priority: Number(document.getElementById('f_priority').value),
                    operation: Number(document.getElementById('f_op').value),
                    processingTime: Number(document.getElementById('f_proc').value)
                };
                await postJSON('add-flight', body);
                addLog(`Flight ${body.id} added`, 'success');
                showToast('Flight added', 'success');
                refreshData();
            } catch (e) {
                addLog('Add flight failed: ' + e.message, 'error');
                showToast('Add flight failed', 'error');
            }
        }

        async function apiDeleteFlight() {
            try {
                const id = document.getElementById('d_id').value;
                await postJSON('delete-flight', { id });
                addLog(`Flight ${id} deleted`, 'warning');
                showToast('Flight deleted', 'warning');
                refreshData();
            } catch (e) {
                addLog('Delete flight failed: ' + e.message, 'error');
            }
        }

        async function apiEmergency() {
            try {
                const body = {
                    type: Number(document.getElementById('e_type').value),
                    id: document.getElementById('e_id').value || 'EM999',
                    airline: document.getElementById('e_airline').value || 'Airline',
                    source: document.getElementById('e_src').value || 'CityA',
                    destination: document.getElementById('e_dest').value || 'CityB',
                    processingTime: Number(document.getElementById('e_proc').value) || 10,
                    details: document.getElementById('e_details').value || 'Emergency'
                };
                await postJSON('emergency', body);
                addLog(`Emergency added for ${body.id}`, 'error');
                showToast('Emergency triggered', 'error');
                refreshData();
            } catch (e) {
                addLog('Emergency failed: ' + e.message, 'error');
            }
        }
        // Global variables
        let autoRefreshInterval = null;
        let isAutoRefreshing = false;
        let refreshCount = 0;
        let lastDataTimestamp = 0;
        let connectionAttempts = 0;

        // Configuration
        const REFRESH_INTERVAL = 2000; // 2 seconds
        const MAX_LOG_ENTRIES = 100;

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <span style="font-size: 1.5em;">${type === 'success' ? '✅' : type === 'error' ? '❌' : '⚠️'}</span>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Update connection status
        function updateConnectionStatus(connected, details = '') {
            const indicator = document.getElementById('statusIndicator');
            const status = document.getElementById('connectionStatus');
            const statusDetails = document.getElementById('statusDetails');
            const systemStatus = document.getElementById('systemStatus');
            
            if (connected) {
                indicator.className = 'status-indicator status-connected';
                status.textContent = '● Connected to C Backend';
                status.style.color = '#10b981';
                systemStatus.textContent = 'Active';
                systemStatus.style.color = '#10b981';
                connectionAttempts = 0;
            } else {
                indicator.className = 'status-indicator status-disconnected';
                status.textContent = '● Backend Disconnected';
                status.style.color = '#ef4444';
                systemStatus.textContent = 'Offline';
                systemStatus.style.color = '#ef4444';
                connectionAttempts++;
            }
            
            statusDetails.textContent = details;
        }

        // Load JSON data from backend
        async function loadJSON(filename) {
            try {
                const cacheBuster = Date.now();
                const response = await fetch(`../src/data/${filename}?t=${cacheBuster}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                lastDataTimestamp = data.timestamp || Date.now();
                return data;
            } catch (error) {
                console.error(`Error loading ${filename}:`, error);
                addLog(`Failed to load ${filename}: ${error.message}`, 'error');
                return null;
            }
        }

        // Refresh all data
        async function refreshData() {
            refreshCount++;
            addLog(`[${refreshCount}] Refreshing data from backend...`, 'info');
            
            try {
                const [stats, queues, runways] = await Promise.all([
                    loadJSON('stats.json'),
                    loadJSON('queues.json'),
                    loadJSON('runways.json')
                ]);
                
                if (stats || queues || runways) {
                    const dataAge = Date.now() / 1000 - (lastDataTimestamp || 0);
                    const details = `Refresh #${refreshCount} | Data age: ${Math.floor(dataAge)}s`;
                    
                    updateConnectionStatus(true, details);
                    
                    if (stats) updateStats(stats);
                    if (queues) updateQueues(queues);
                    if (runways) updateRunways(runways);
                    
                    const now = new Date();
                    document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
                    
                    addLog(`✅ Data refreshed successfully (${refreshCount})`, 'success');
                    
                    if (refreshCount === 1) {
                        showToast('Connected to backend successfully!', 'success');
                    }
                } else {
                    throw new Error('No data received from backend');
                }
            } catch (error) {
                updateConnectionStatus(false, `Attempt ${connectionAttempts}`);
                addLog(`❌ Connection failed: ${error.message}`, 'error');
                
                if (connectionAttempts === 1) {
                    showToast('Backend not responding. Start the C program!', 'error');
                }
            }
        }

        // Update statistics display
        function updateStats(data) {
            const algoMap = {
                1: 'FCFS',
                2: 'Priority',
                3: 'SJF',
                4: 'Round Robin'
            };
            
            document.getElementById('currentTime').textContent = data.currentTimeStr || '--:--';
            document.getElementById('currentAlgo').textContent = 
                data.algorithmStr || algoMap[data.algorithm] || 'Unknown';
            
            const statsHTML = `
                <div class="stat-card">
                    <div class="stat-value">${data.totalFlightsProcessed || 0}</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${(data.averageWaitTime || 0).toFixed(1)}</div>
                    <div class="stat-label">Avg Wait (min)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${data.runwayAHandled || 0}</div>
                    <div class="stat-label">Runway A</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${data.runwayBHandled || 0}</div>
                    <div class="stat-label">Runway B</div>
                </div>
            `;
            document.getElementById('statsContainer').innerHTML = statsHTML;
        }

        // Update queues display
        function updateQueues(data) {
            const landingContainer = document.getElementById('landingQueue');
            const takeoffContainer = document.getElementById('takeoffQueue');
            const landingCount = document.getElementById('landingCount');
            const takeoffCount = document.getElementById('takeoffCount');
            
            // Landing Queue
            if (!data.landingQueue || data.landingQueue.length === 0) {
                landingContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">✅</div>
                        <div class="empty-text">No flights in landing queue</div>
                    </div>
                `;
                landingCount.textContent = '0';
            } else {
                landingContainer.innerHTML = data.landingQueue.map(f => createFlightCard(f)).join('');
                landingCount.textContent = data.landingQueue.length;
            }
            
            // Takeoff Queue
            if (!data.takeoffQueue || data.takeoffQueue.length === 0) {
                takeoffContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">✅</div>
                        <div class="empty-text">No flights in takeoff queue</div>
                    </div>
                `;
                takeoffCount.textContent = '0';
            } else {
                takeoffContainer.innerHTML = data.takeoffQueue.map(f => createFlightCard(f)).join('');
                takeoffCount.textContent = data.takeoffQueue.length;
            }
        }

        // Create flight card HTML
        function createFlightCard(flight) {
            const priorityClass = flight.priority === 3 ? 'priority-emergency' : 
                                 flight.priority === 2 ? 'priority-vip' : '';
            const priorityText = ['', 'Scheduled', 'VIP', 'Emergency'][flight.priority] || 'Unknown';
            const badgeClass = ['', 'badge-scheduled', 'badge-vip', 'badge-emergency'][flight.priority] || '';
            
            return `
                <div class="flight-card ${priorityClass}">
                    <div class="flight-header">
                        <div>
                            <div class="flight-id">${flight.id}</div>
                            <div class="flight-airline">${flight.airline}</div>
                        </div>
                        <div>
                            <span class="badge ${badgeClass}">${priorityText}</span>
                        </div>
                    </div>
                    <div class="flight-details">
                        <div><strong>Processing:</strong> ${flight.processingTime} min</div>
                        <div><strong>Priority:</strong> Level ${flight.priority}</div>
                    </div>
                </div>
            `;
        }

        // Update runways display
        function updateRunways(data) {
            if (!data.runways) return;
            
            const container = document.getElementById('runwayContainer');
            
            const html = data.runways.map(runway => {
                const statusClass = runway.occupied ? 'occupied' : 'available';
                const statusIcon = runway.occupied ? '🔴' : '🟢';
                const statusText = runway.occupied ? 'OCCUPIED' : 'AVAILABLE';
                
                let statusContent = `<div><strong>${statusIcon} ${statusText}</strong></div>`;
                
                if (runway.occupied && runway.currentFlight) {
                    statusContent += `
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.3);">
                            <div><strong>Flight:</strong> ${runway.currentFlight.id}</div>
                            <div><strong>Airline:</strong> ${runway.currentFlight.airline}</div>
                            <div><strong>Type:</strong> ${runway.currentFlight.operation}</div>
                            <div style="margin-top: 8px;"><strong>Available:</strong> ${runway.availableAtStr}</div>
                        </div>
                    `;
                } else {
                    statusContent += `<div style="margin-top: 10px; opacity: 0.8;">Ready for operations</div>`;
                }
                
                statusContent += `<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.3);"><strong>Total Handled:</strong> ${runway.totalFlightsHandled} flights</div>`;
                
                return `
                    <div class="runway-card">
                        <div class="runway-name">${runway.name}</div>
                        <div class="runway-status ${statusClass}">
                            ${statusContent}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        // Add log entry
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('systemLog');
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timeStr}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // Keep only last MAX_LOG_ENTRIES entries
            while (logContainer.children.length > MAX_LOG_ENTRIES) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }

        // Clear logs
        function clearLogs() {
            const logContainer = document.getElementById('systemLog');
            logContainer.innerHTML = '';
            addLog('Log cleared', 'info');
            showToast('Logs cleared successfully', 'success');
        }

        // Toggle auto-refresh
        function toggleAutoRefresh() {
            const btn = document.getElementById('autoRefreshBtn');
            const refreshRate = document.getElementById('refreshRate');
            
            if (isAutoRefreshing) {
                clearInterval(autoRefreshInterval);
                isAutoRefreshing = false;
                btn.innerHTML = '▶️ Start Auto-Refresh';
                btn.className = 'btn btn-success';
                refreshRate.textContent = 'Manual';
                addLog('Auto-refresh stopped', 'warning');
                showToast('Auto-refresh disabled', 'warning');
            } else {
                autoRefreshInterval = setInterval(refreshData, REFRESH_INTERVAL);
                isAutoRefreshing = true;
                btn.innerHTML = '⏸️ Stop Auto-Refresh';
                btn.className = 'btn btn-danger';
                refreshRate.textContent = `Every ${REFRESH_INTERVAL/1000}s`;
                addLog(`Auto-refresh started (every ${REFRESH_INTERVAL/1000} seconds)`, 'success');
                showToast('Auto-refresh enabled!', 'success');
                refreshData(); // Immediate refresh
            }
        }

        // Initial load
        window.addEventListener('load', () => {
            addLog('🚀 Dashboard initialized', 'success');
            addLog('📡 Attempting to connect to backend...', 'info');
            
            // Initial data fetch
            setTimeout(() => {
                refreshData();
            }, 500);
            
            // Auto-start refresh after 2 seconds if user doesn't click
            setTimeout(() => {
                if (!isAutoRefreshing) {
                    addLog('💡 Tip: Click "Start Auto-Refresh" for live updates!', 'info');
                }
            }, 3000);
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        });
    </script>
</body>
</html>
